<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<style>
			.area {
				margin: 20px auto 0px auto;
			}
			.mui-input-group:first-child {
				margin-top: 20px;
			}
			.mui-input-group label {
				width: 22%;
			}
			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				width: 78%;
			}
			.mui-checkbox input[type=checkbox],
			.mui-radio input[type=radio] {
				top: 6px;
			}
			.mui-content-padded {
				margin-top: 25px;
			}
			.mui-btn {
				padding: 10px;
			}
			.mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea{
				margin-top: 1px;
			}
			.mui-btn-primary{
				background-color: #ffa52a;
				border-style: none;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">Set Condo Name</h1>
		</header>
		<div class="mui-content">
		<p id="currentAddress">Current Address: <span id="currentAddressValue">Loading...</span></p>
		<form id="updateForm">
		    New Address:<br>
		    <input type="text" id="address" name="address">
		    <br>
		    <div class="mui-content-padded">
		        <button type="submit" class="mui-btn mui-btn-block mui-btn-primary">Update Address</button>
		    </div>
		</form>

		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script>
		// 页面加载完成后，添加 submit 事件监听器而不是 onclick
		document.addEventListener('DOMContentLoaded', function() {
		    const username = localStorage.getItem('user_name');
		    getCurrentAddress(username);
		
		    document.getElementById('updateForm').addEventListener('submit', function(event) {
		        event.preventDefault(); // 阻止表单的默认提交行为
		        updateAddress();
		    });
		});

		// 定义获取当前地址的函数
		function getCurrentAddress(username) {
			fetch('https://ts.tuotuohome.asia/getGuardLocation.php', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ username: username }),
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// 如果成功获取到地址，则显示在页面上
					document.getElementById('currentAddressValue').textContent = data.location;
				} else {
					// 如果获取地址失败，则显示错误信息
					document.getElementById('currentAddressValue').textContent = 'Address not available';
				}
			})
			.catch((error) => {
				console.error('Error fetching current address:', error);
				document.getElementById('currentAddressValue').textContent = 'Error fetching address';
			});
		}

		// 定义更新地址的函数
		function updateAddress() {
			const address = document.getElementById('address').value;
			const username = localStorage.getItem('user_name');

			fetch('https://ts.tuotuohome.asia/location.php', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ username: username, address: address }),
			})
			.then(response => {
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				return response.text();
			})
			.then(text => {
				try {
					const data = JSON.parse(text);
					alert('Address updated successfully!');
					window.location.replace("guard_main.html");
				} catch (error) {
					console.error('Error parsing JSON:', error);
					alert('Failed to update address.');
				}
			})
			.catch((error) => {
				console.error('Fetch error:', error);
				alert('Failed to update address.');
			});
		}
		</script>

	</body>

</html>