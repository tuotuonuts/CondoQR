<!DOCTYPE html>
<html class="ui-page-login">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <style>
        .area {
            margin: 20px auto 0px auto;
        }
        .mui-input-group:first-child {
            margin-top: 20px;
        }
        .mui-input-group label {
            width: 22%;
        }
        .mui-input-row label~input,
        .mui-input-row label~select,
        .mui-input-row label~textarea {
            width: 78%;
        }
        .mui-checkbox input[type=checkbox],
        .mui-radio input[type=radio] {
            top: 6px;
        }
        .mui-content-padded {
            margin-top: 25px;
        }
        .mui-btn {
            padding: 10px;
        }
        .mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea{
            margin-top: 1px;
        }
        .mui-btn-primary{
            background-color: #ffa52a;
            border-style: none;
        }
    </style>
</head>

<body>
<header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">Register for an account</h1>
</header>
<div class="mui-content">

    <!--
    <div class="mui-input-row">
        <label>账号</label>
        <input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入账号">
    </div>
    -->


    <div class="mui-content-padded">
        
        <div class="center">
            <select id="cameraSelect"></select>
        </div>
        <button id="startButton" class="mui-btn mui-btn-block mui-btn-primary">Scan QR Code</button>
        <div id="reader"></div>
    </div>
</div>
<script src="js/mui.min.js"></script>
<script src="js/app.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    var guard_username = localStorage.getItem('user_name'); // Assuming this is how you get the current user's name
    const cameraSelect = document.getElementById("cameraSelect");
    const startButton = document.getElementById("startButton");
    let html5QrCode;

    Html5Qrcode.getCameras().then(cameras => {
        cameras.forEach((camera, index) => {
            const option = document.createElement("option");
            option.value = camera.id;
            option.text = camera.label || `Camera ${index}`;
            cameraSelect.appendChild(option);
        });
    });

	function startScan(cameraId) {
		html5QrCode = new Html5Qrcode("reader");
		const config = { fps: 10, qrbox: { width: 250, height: 250 } };
		
		// 获取守卫的位置信息
		getGuardLocation(guard_username).then(location => {
			// 成功获取位置信息后，开始扫描
			html5QrCode.start(
				cameraId,
				config,
				(decodedText, decodedResult) => {
					// 假设 QR 码的数据格式是："CondoQR,rider_username,timestamp"
					const dataParts = decodedText.split(',');
					if (dataParts[0] === "CondoQR" && dataParts.length === 3) {
						const rider_username = dataParts[1];
						const QRtime = dataParts[2]; // 这是 QR 码中的时间戳
						const scanTime = Math.floor(Date.now() / 1000); // 当前时间戳（秒单位）
						
						// 停止 QR 码扫描，防止重复扫描
						html5QrCode.stop().then(() => {
							console.log("QR code scanning stopped.");
							// 将 QR 时间和扫描时间连同其他数据一起发送到服务器
							sendDataToDatabase(rider_username, QRtime, scanTime, guard_username, location);
						}).catch(err => {
							console.error("Failed to stop QR code scanning:", err);
						});
					} else {
						alert("Failed to scan QR code: Invalid format");
					}
				},
				(errorMessage) => {
					// 打印错误消息
					console.error(errorMessage);
				}
			).catch(err => console.error(`Failed to start QR code scanning: ${err}`));
		}).catch(error => {
			// 无法获取守卫的位置信息
			alert("Failed to get the guard's location. Error: " + error);
			console.error("Error:", error);
		});
	}
	// 一个新的函数，用来获取守卫的位置
	function getGuardLocation(guardUsername) {
		return new Promise((resolve, reject) => {
			fetch(`https://ts.tuotuohome.asia/getGuardLocation.php`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ username: guardUsername }),
			})
			.then(response => response.json())
			.then(data => {
				if (data.success && data.location) {
					resolve(data.location);
				} else {
					reject("Location not found for the guard.");
				}
			})
			.catch((error) => {
				reject(error);
			});
		});
	}



    startButton.addEventListener('click', () => {
        const selectedCameraId = cameraSelect.value;
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                startScan(selectedCameraId);
            }).catch(err => {
                console.error("Error stopping the QR scanner", err);
                startScan(selectedCameraId);
            });
        } else {
            startScan(selectedCameraId);
        }
    });

function sendDataToDatabase(username, QRtime, scanTime, guard_username, scannerLocation) {
    // Prepare data to be sent to the server
    const dataToSend = {
        rider_username: username,
        QRtime: QRtime, // Time from the QR code
        scanTime: scanTime, // Current time when the QR code was scanned
        guard_username: guard_username,
        scannerLocation: scannerLocation,
    };

    // Example of sending the prepared data to a server-side script
    fetch('https://ts.tuotuohome.asia/submitQRData.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSend),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("QR code scanned successfully!");
			window.location.replace("guard_main.html");
        } else {
            alert("Failed to submit data: " + data.message);
        }
    })
    .catch((error) => {
        alert("Failed to scan QR code. Error: " + error);
        console.error("Error:", error);
    });
}

});
</script>



</body>

</html>